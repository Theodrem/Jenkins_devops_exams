pipeline {
    environment {
        DOCKER_ID = "sajjadhz"
        DOCKER_IMAGE = "fastapiapp"
        DOCKER_TAG = "v.${BUILD_ID}.0"
    }
    agent any
    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/Theodrem/Jenkins_devops_exams.git'
            }
        }

        stage('Docker Build & Push') {
            environment {
                DOCKER_PASS = credentials("DOCKER_HUB_PASS")
            }
            steps {
                script {
                    sh '''
                    echo "Suppression des anciens conteneurs"
                    docker rm -f fastapiapp || true
                    echo "Construction de l'image Docker"
                    docker build -t $DOCKER_ID/$DOCKER_IMAGE:$DOCKER_TAG .
                    echo "Connexion à DockerHub"
                    docker login -u $DOCKER_ID -p $DOCKER_PASS
                    echo "Push de l'image vers DockerHub"
                    docker push $DOCKER_ID/$DOCKER_IMAGE:$DOCKER_TAG
                    '''
                }
            }
        }

        stage('Déploiement en Dev') {
            environment {
                KUBECONFIG = credentials("config")
            }
            steps {
                script {
                    sh '''
                    echo "Configuration de Kubeconfig"
                    rm -Rf .kube
                    mkdir .kube
                    cat $KUBECONFIG > .kube/config
                    echo "Mise à jour du tag d'image dans Helm"
                    cp fastapi/values.yaml values.yml
                    sed -i "s+tag:.*+tag: ${DOCKER_TAG}+g" values.yml
                    echo "Déploiement en Dev"
                    helm upgrade --install fastapiapp fastapi --values=values.yml --namespace dev
                    '''
                }
            }
        }

        stage('Déploiement en Staging') {
            environment {
                KUBECONFIG = credentials("config")
            }
            steps {
                script {
                    sh '''
                    echo "Mise à jour du tag d'image dans Helm"
                    cp fastapi/values.yaml values.yml
                    sed -i "s+tag:.*+tag: ${DOCKER_TAG}+g" values.yml
                    echo "Déploiement en Staging"
                    helm upgrade --install fastapiapp fastapi --values=values.yml --namespace staging
                    '''
                }
            }
        }

        stage('Déploiement en Production') {
            environment {
                KUBECONFIG = credentials("config")
            }
            steps {
                script {
                    timeout(time: 15, unit: "MINUTES") {
                        input message: 'Valider le déploiement en production ?', ok: 'Déployer'
                    }
                    sh '''
                    echo "Mise à jour du tag d'image dans Helm"
                    cp fastapi/values.yaml values.yml
                    sed -i "s+tag:.*+tag: ${DOCKER_TAG}+g" values.yml
                    echo "Déploiement en Production"
                    helm upgrade --install fastapiapp fastapi --values=values.yml --namespace prod
                    '''
                }
            }
        }
    }
}
